# rabbitmq重复消费问题及源码层分析

1.为什么会出现消息的重复消费？

一般问题出在任务超时，或者没有及时返回状态，从而导致消息重新进入消息队列，进而重复消费。

同时如果在执行任务的时候，消费者端与 rabbitmq 的链接断开也会导致消息重新进入消费队列。

2.解决思路：

消费的任务，最好能保持幂等性。这样的好处是不管任务重复执行多少次结果都一样。如果任务是在不支持幂等，比如发送短信。那么就需要构建一个记录任务执行情况的记录表。不仅是记录成功或失败，还要记录心跳。这个记录表在消费者端就能实现。

在一般的 rabbitmq 和 rocketMQ 等队列中间件中，经常由于任务内抛出异常而导致任务失败，且对于队列端没有状态的返回，所以消息会重新返回队列中从而导致重复消费。

3.办法一：

准备一个第三方存储,来做消费记录。以redis为例，给消息分配一个全局id，只要消费过该消息，将<id,message>以K-V形式写入redis。那消费者开始消费前，先去redis中查询有没消费记